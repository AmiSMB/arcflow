#!/bin/sh

BRANCH=`git status | grep 'On branch' | awk '{print $NF}'`

set -e

warn() { echo "$@" >&2; }
die() { warn "ERROR: $@"; exit 1; }

type_from_branch()
{
  IFS='/' read -a _DATA <<< "$BRANCH"
  echo "${_DATA[0]}"
}

task_from_branch()
{
  IFS='/' read -a _DATA <<< "$BRANCH"
  echo "${_DATA[1]}"
}

require_branch()
{
  if [ "$BRANCH" = "" ] || [ "$BRANCH" = "master" ] || [ "$BRANCH" = "develop" ] ; then
    die "Cannot submit $BRANCH for review, you are not on a feature branch."
  fi
}

cmd_help()
{
	echo "usage: arcflow <subcommand>"
	echo
	echo "Available subcommands are:"
	echo "   help      This page."
	echo "   start     Start work on a task."
	echo "   review    Submit this branch for review."
	echo "   finish    Merge the branch into develop."
	echo "   abandon   Abandon the this branch and delete it from the repo."
}

# arcflow start Txxx
cmd_start()
{
  # must start from develop
  git checkout develop >/dev/null 2>&1

  local _TASKID="$1"; shift
  local _TASKS=`arc tasks`
  if [ "$_TASKID" = "" ] ; then
    die "No task specified\n$_TASKS";
  fi

  local _TAS=`arc tasks --owner @all | sed -E '/^'"$_TASKID"' /!d; s/ {2,}/<TAB>/g; s/^'"$_TASKID"' (.*)<TAB>(.*)<TAB>[a-zA-Z]*$/\1~\2/'`
  IFS='~' read _TITLE _TYPE <<< "$_TAS"

  if [ "$_TITLE" = "" ] ; then
    die "Task $_TASKID not found.\n$_TASKS";
  fi

  # TODO: not very flexible: Hotfix, Bug, Release Candidate, Feature
  local _FLOWTYPE=''
  if [ "$_TYPE" = "Hotfix" ]; then
    _FLOWTYPE='hotfix'
  elif [ "$_TYPE" = "Bug" ]; then
    _FLOWTYPE='feature'
  elif [ "$_TYPE" = "Feature" ]; then
    _FLOWTYPE='feature'
  elif [ "$_TYPE" = "Release Candidate" ]; then
    _FLOWTYPE='release'
  fi

  if [ "$_FLOWTYPE" = '' ]; then
    die "Task type '$_TYPE' not supported in arcflow"
  fi

  # start the hotfix/bug/release
  local _ERR=`git flow "$_FLOWTYPE" start "$_TASKID" 2>&1 >/dev/null`
  if [ "$_ERR" != "" ] ; then
    local _NOERR=`echo "$_ERR" | sed '/^Branch .* already exists. Pick another name.$/!d'`
    if [ "$_NOERR" != "" ] ; then
      #branch already exists, see if its in our local branch list
      git checkout "$_FLOWTYPE/$_TASKID" >/dev/null 2>&1
    else
      local _NOERR=`echo "$_ERR" | sed '/^Switched to a new branch .*$/!d'`
      if [ "$_NOERR" = "" ] ; then
        die "$_ERR"
      fi
    fi
  fi

  local _ERR=`git branch --set-upstream-to origin/"$_FLOWTYPE"/"$_TASKID" 2>&1 >/dev/null`
  #if branch failed, git push, else git pull --rebase
  if [ "$_ERR" != "" ] ; then
    local _NOERR=`echo "$_ERR" | sed '/^error: the requested upstream branch .* does not exist$/!d'`
    if [ "$_NOERR" != "" ] ; then
      echo "Starting $_TYPE $_TASKID - $_TITLE"
      git push --set-upstream origin "$_FLOWTYPE"/"$_TASKID" >/dev/null 2>&1
    fi
    die "$_ERR"
  else
    echo "Resuming $_TYPE $_TASKID - $_TITLE"
    git pull --rebase >/dev/null 2>&1
  fi

  echo "Now, start committing to your $_TYPE. When done, use:\n\n      arcflow review\n"
}

# arcflow review
cmd_review()
{
  require_branch
  git pull --rebase
  git rebase develop
  echo "Submitting $BRANCH for review."
  git push
  arc diff develop
}

# arcflow finish
cmd_finish()
{
  require_branch
  git pull --rebase
  git rebase develop
  local _TYPE=`type_from_branch`
  local _TASK=`task_from_branch`
  git flow "$_TYPE" finish "$_TASK"
  git push
}

cmd_abandon()
{
  require_branch
  read -p "Are you sure you wish to abandon $BRANCH [y/N]? " -r
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    delete_branch
  fi
}

delete_branch()
{
  require_branch
  git checkout develop
  git branch -d "$BRANCH"
  git push origin :"$BRANCH"
}

SUBCOMMAND="$1"
if [ "" = "$SUBCOMMAND" ]; then
  cmd_help
elif ! type "cmd_$SUBCOMMAND" >/dev/null 2>&1; then
	die "Unknown subcommand: '$SUBCOMMAND'\n`cmd_help`"
else
  shift
  cmd_$SUBCOMMAND "$@"
fi
